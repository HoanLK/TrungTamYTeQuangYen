admin.controller("modifyGalleryController",["$scope","$http","$window","$location","$filter","Alias","Url",function(n,t,i,r,u,f,e){function c(){n.gallery.id!==null?a(n.gallery.id):l()}function l(){n.gallery={featured:!1,published:!0,version:1,robots:"Index, Follow",timePublished:new Date}}function a(){t.get(s+"/"+n.gallery.id).then(function(i){n.gallery=angular.copy(i.data);n.gallery.timePublished=new Date(n.gallery.timePublished);t.get(o+"?att=idGallery&&value="+n.gallery.id).then(function(t){n.images=angular.copy(t.data)},function(){})},function(){i.location.href="/Admin/Gallery"})}var s="/API/GalleryAPI",o,h;n.gallery={};o="/API/ImageAPI";n.image={};n.imageList={};n.images=[];n.statuses=[{text:"Xuất bản",value:!0},{text:"Không xuất bản",value:!1}];n.featureds=[{text:"Có",value:!0},{text:"Không",value:!1}];n.gallery.id=e.getParameterByName("idGallery");n.modifyImage=!1;n.deleteImage=!1;n.titlePopupModifyImage="Thêm hình ảnh";n.popupModifyImage={width:500,height:600,contentTemplate:"templateModifyImage",showTitle:!0,resizeEnabled:!0,bindingOptions:{title:"titlePopupModifyImage",visible:"modifyImage"}};n.popupDeleteImage={width:"auto",height:"auto",contentTemplate:"templateDeleteImage",showTitle:!1,bindingOptions:{visible:"deleteImage"}};h=[{value:"add",text:" Thêm",icon:"fa fa-plus"},{value:"edit",text:" Sửa",icon:"fa fa-pencil"},{value:"delete",text:" Xóa",icon:"fa fa-times"}];n.contextMenuImage={dataSource:h,width:100,target:"#listImage",itemTemplate:function(n){var t=$("<div><\/div>");return n.icon&&t.append('<span class="'+n.icon+'"><span>'),t.append(n.text),t},onItemClick:function(t){if(!t.itemData.items)switch(t.itemData.value){case"add":n.AddImage();break;case"edit":n.EditImage();break;case"delete":n.DeleteImage()}}};n.imageList={width:"100%",height:500,baseItemHeight:200,baseItemWidth:200,itemMargin:10,direction:"vertical",showScrollbar:!0,bindingOptions:{items:"images"},onItemContextMenu:function(t){n.image={};n.image=angular.copy(n.images[t.itemIndex]);n.image.index=angular.copy(t.itemIndex)}};c();n.Save=function(){n.gallery.id==null?t.post(s,n.gallery).then(function(i){n.gallery=angular.copy(i.data);angular.forEach(n.images,function(i,r){i.idGallery=n.gallery.id;t.post(o,i).then(function(){r==n.images.length-1&&toastr.success("Thành công","Thêm thư viện Ảnh")},function(){})})},function(){toastr.error("Thất bại","Thêm thư viện Ảnh")}):t.put(s+"/"+n.gallery.id,n.gallery).then(function(){t.get("/Gallery/DeleteImages/"+n.gallery.id).then(function(i){i.data==1&&angular.forEach(n.images,function(i,r){i.idGallery=n.gallery.id;t.post(o,i).then(function(t){n.images[r]=angular.copy(t.data)},function(){})})},function(){toastr.error("Thất bại","Không cập nhật được hình ảnh")});toastr.success("Thành công","Lưu thông tin thư viện Ảnh")},function(){toastr.error("Thất bại","Lưu thư viện Ảnh")})};n.SaveAndExit=function(){n.gallery.id==null?t.post(s,n.gallery).then(function(r){n.gallery=angular.copy(r.data);angular.forEach(n.images,function(r,u){r.idGallery=n.gallery.id;t.post(o,r).then(function(){u==n.images.length-1&&(toastr.success("Thành công","Thêm thư viện Ảnh"),i.location.href="/Admin/Gallery")},function(){})})},function(){toastr.error("Thất bại","Thêm thư viện Ảnh")}):t.put(s+"/"+n.gallery.id,n.gallery).then(function(){t.get("/Gallery/DeleteImages/"+n.gallery.id).then(function(i){i.data==1&&angular.forEach(n.images,function(i,r){i.idGallery=n.gallery.id;t.post(o,i).then(function(t){n.images[r]=angular.copy(t.data)},function(){})})},function(){toastr.error("Thất bại","Không cập nhật được hình ảnh")});toastr.success("Thành công","Lưu thông tin thư viện Ảnh");i.location.href="/Admin/Gallery"},function(){toastr.error("Thất bại","Lưu thư viện Ảnh")})};n.SaveAndAdd=function(){n.gallery.id==null?t.post(s,n.gallery).then(function(r){n.gallery=angular.copy(r.data);angular.forEach(n.images,function(r,u){r.idGallery=n.gallery.id;t.post(o,r).then(function(){u==n.images.length-1&&(toastr.success("Thành công","Thêm thư viện Ảnh"),i.location.href="/Admin/Gallery/Modify")},function(){})})},function(){toastr.error("Thất bại","Thêm thư viện Ảnh")}):t.put(s+"/"+n.gallery.id,n.gallery).then(function(){t.get("/Gallery/DeleteImages/"+n.gallery.id).then(function(i){i.data==1&&angular.forEach(n.images,function(i,r){i.idGallery=n.gallery.id;t.post(o,i).then(function(t){n.images[r]=angular.copy(t.data)},function(){})})},function(){toastr.error("Thất bại","Không cập nhật được hình ảnh")});toastr.success("Thành công","Lưu thông tin thư viện Ảnh");i.location.href="/Admin/Gallery/Modify"},function(){toastr.error("Thất bại","Lưu thư viện Ảnh")})};n.Cancel=function(){i.location.href="/Admin/Gallery"};n.ChooseImage=function(){var t=new CKFinder;t.selectActionFunction=function(t){n.gallery.image=t;n.$apply()};t.SelectFunction="ShowFileInfo";t.popup()};n.AddImage=function(){n.image={};n.titlePopupModifyImage="Thêm hình ảnh";n.modifyImage=!0};n.EditImage=function(){n.titlePopupModifyImage="Sửa hình ảnh";n.image=={}?toastr.error("Chọn ảnh để sửa"):n.modifyImage=!0};n.SaveImage=function(){angular.isDefined(n.image.index)?n.images[n.image.index]=n.image:n.images.push(n.image);n.modifyImage=!1};n.CancelSaveImage=function(){n.modifyImage=!1};n.DeleteImage=function(){n.deleteImage=!0};n.ConfirmDeleteImage=function(){n.images.splice(n.image.index,1);n.deleteImage=!1};n.CancelDeleteImage=function(){n.deleteImage=!1};n.ChooseImageGallery=function(){var t=new CKFinder;t.selectActionFunction=function(t){n.image.url=t;n.$apply()};t.SelectFunction="ShowFileInfo";t.popup()};n.GenAlias=function(){n.gallery.alias=angular.copy(f.genAlias(n.gallery.title))}}]);